目录
1. HyperSnap(LUN)
2. HyperSnap(FS)
3. HyperReplication
4. HyperClone

LUN快照概述

- 定义 快照是指源数据在某个时间点的一致性数据副本。快照生成后可被主机读取，可以作为某个时间点的数据备份
- 快照主要特点 1. 瞬间生成 存储系统可以在几秒内生成一个快照，获取源数据的一致性副本。 2. 占用存储空间小 生成的快照数据并非完整的物理数据拷贝，不会占用大量存储空间，即使数据量大也占用很少存储空间

相关概念

|中文|英文|定义/描述|
|:---:|:---|:---|
|源卷|source volume|需要进行快照操作的源数据所在卷，对用户表现为LUN，源卷包括meta volume和data volume -meta volume记录源数据在源卷中存在的位置 -data volume 记录源卷中存放的数据|
|COW数据空间|COW data space|快照生成并激活后，发生写前拷贝时，从存储池分配的存储空间，用于保存源卷在激活时间点的数据。同一个源卷对应所有快照卷共享一个COW数据空间|
|快照卷|snapshot volume|对源卷创建快照后，逻辑上生成数据副本，对用户而言，表现为快照LUN|
|快照回滚|snapshot rollback|将快照LUN的数据复制给源LUN，从而使源LUN的数据恢复成生成快照LUN时刻的数据|
|映射表|mappingtable|映射表用于记录源卷数据和快照卷数据在某个时刻点的改变情况以及改变后数据存储位置，分共享部分和非共享部分|
|未激活状态|Inactive|快照的一种状态，在这种状态下快照不可用，需要进行激活操作后可用|

COW(Copy over Write) 写前拷贝，即在主机写快照源LUN之前，先将源LUN的保护数据拷贝到其它地方，拷贝完成后，主机IO才继续写源LUN
COW数据空间 
共享映射表 激活快照后，快照源LUN上发生的变更统一存放在共享映射表上，一个源LUN上的所有快照共同使用该映射表
独享映射表 激活快照后，快照卷上写入的数据都记录在独享映射表上，每个快照都有自己一张独享映射表

映射表
---

用于表示快照数据映射关系，形象的说就是“指针”
- 映射项的左项为源地址，作为查找键值
- 右项记录资源块的地址
- 可以对表中的项进行添加和删除
- 使用B+树方式保存

映射表用来表示快照的实际数据所在；映射表分为两类：独享映射表和共享映射表。原理相同，不同在于独享映射表记录写快照发生的数据变更，共享映射表记录的是写源LUN发生的变更

副本 写前回滚

回滚过程中，主机对源LUN进行写时，快照会先将快照中的数据块拷贝到源LUN后，主机IO再继续写；没有主机读写时，快照中的数据是依次向源卷回滚

- 快照回滚命令执行前，要求停止对源卷的读写。因为主机对源卷的写数据会被快照回滚覆盖掉
- 快照回滚命令执行成功后，主机可以对源卷进行读写，写前回滚技术保证了达到瞬时完成回滚的效果
- 快照回滚过程中，不能进行在线升级
- 快照回滚是将快照红的数据复制到源卷上，包含了写快照产生的数据



HyperSnap(FS)
===

相关概念

|缩略语|英文全名|中文解释|
|:---:|:---|:---|
|ROW|Redirect On Write|写时重定向，即数据修改写时，不覆盖磁盘上的旧数据，而是新分配磁盘空间将数据写入|
|COW|Copy On Write|写时拷贝 即数据修改写入时，将磁盘上的旧数据拷贝到新位置，而将新数据直接写入旧数据原有的磁盘位置|

ROW技术
---

1. 整个文件系统布局成树形结构
2. 用户覆盖写入数据时，重新分配磁盘空间进行写入，而不是直接写入原有磁盘空间。
3. 数据修改后，相应的元数据按照同样的策略进行修改
4. 修改到根节点后，整个覆盖写操作完成
5. 当不存在快照时，覆盖掉的磁盘空间将会回收

统一存储实现了ROW型文件系统，即采用写时重定向方式的文件系统： 当新写入或修改写入用户数据时，新数据不会覆盖掉原来的旧数据，而是在存储介质上新分配空间写入数据。此种类型文件系统，具备高可靠性、高扩展性的特点，并逐步成为目前文件系统主流(如ZFS、Btrfs、nilfs等)

快照创建
---

为文件系统创建快照时，仅只需要拷贝文件系统的根节点并保存，就形成了一个文件系统的快照。整个过程不需要拷贝任何用户数据，因此整个过程耗时极少，通常在一两秒完成。并且在数据被修改之前，快照的文件集与主文件系统共同使用文件系统空间，无需单独为快照分配特定的空间。

快照创建成功后，会在文件系统根目录下又一个特殊的快照目录，该目录下包含了这个文件系统的所有快照，每一个快照是其一个子目录。用户可以通过目录访问的方式直接访问快照目录，而不需要像传统快照一样需要挂载出来才可以访问。

数据更新
---

- 快照刚创建时，快照数据和源文件系统数据是相同的，在磁盘上引用的是同一份数据
- 修改文件数据后，根据ROW机制，新数据会写入新的磁盘空间，并检查旧数据是否受快照保护，若受快照保护，则不释放旧数据空间；否则释放旧数据磁盘空间
- 随着文件系统的更新 被修改过的快照数据会逐步变成快照独自引用的数据，随之快照的占用空间也会逐步增长

快照回滚
---

将文件系统回滚到指定快照，可以迅速恢复数据到快照点时刻，从而避免了快照点后因为人为的错误或者病毒的入侵等引起的源文件系统损坏造成的数据丢失。

快照回滚通过将文件系统的访问入口根节点替换成快照的根节点，并删除掉内存中数据，即可完成回滚

文件系统回滚到指定时间点后，从该时间点到回滚前文件系统的新增修改数据均将丢失。这部分新增修改数据占用的磁盘空间是通过后台任务逐步回收的

快照删除
---

删除快照将释放掉快照的根节点指针及快照的独占数据。而文件系统的数据不会受到任何影响。即回收独占空间，共享数据不会被删除。

统一存储的文件系统快照删除也是快速响应的，快照独占空间通过后台任务逐步回收。


