目录
1. 存储模型
2. 虚拟化存储连接
3. 存储虚拟化原理
4. 存储虚拟化特性
5. 存储虚拟化常用功能

- 存储资源 物理存储设备，如IPSAN、Advanced SAN、NAS等
- 存储设备 存储资源中的管理单元，类LUN、Advanced SAN存储池、NAS共享目录等
- 数据存储 虚拟化平台可管理、操作的存储逻辑单元

一个存储资源可以有多个存储设备；一个数据存储和一个存储设备对应；数据存储承载了具体的虚拟机业务，如创建磁盘等
```txt
逻辑对象                  物理实体
卷  卷
数据存储  数据存储
  ^        ^
  |        |
存储设备  存储设备 <------> 存储池        LUN   共享目录 本地磁盘
  ^        ^               ^            ^      ^
  |        |               |            |      |
  存 储 资 源 <---------->FusionStorage SAN    NAS
```
存储资源类型 FCSAN 、IPSAN 、NAS 、Advanced SAN 、FusionStorage

数据存储 在存储设备上创建的逻辑管理单元：数据存储可以关联到多个主机，一个主机可以使用多个数据存储

数据存储的使用 存储设备只有被添加为数据存储才能被使用；数据存储可用于存放虚拟机磁盘、快照文件；数据存储的大小依赖于存储设备的大小

FCSAN存储场景
```txt
虚拟机磁盘文件直接存放在数据存储中  FusionCompute中使用存储设备创建数据存储
                       DataStore1
  FusionConpute                      FusionCompute
  Server HBA卡                           Server HBA卡
服务器通过HBA卡连接到SAN网络             SAN网络，光纤连接，使用光纤交换机
存储设备:LUN,常见为共享存储方式，LUN挂载给多台主机
```

iSCSI存储场景
```txt
虚拟机磁盘文件直接存放在数据存储中  FusionCompute中使用存储设备创建数据存储
                       DataStore1
  FusionConpute                      FusionCompute
  Server                             Server
服务器通过网卡连接到LAN网络              LAN网络，TCP/IP连接，以太网交换机
存储设备:LUN,常见为共享存储方式，LUN挂载给多台主机
```

NAS存储场景
```txt
虚拟机磁盘文件直接存放在数据存储中  FusionCompute中使用存储设备创建数据存储
                       DataStore1
  FusionConpute                      FusionCompute
  Server                             Server
服务器通过网卡连接到LAN网络              LAN网络，TCP/IP连接，以太网交换机
存储设备:共享文件夹，常见为共享存储方式，共享文件夹映射给多台主机
```
虚拟化的存储栈 将不同存储设备格式化，屏蔽存储设备的能力、接口协议等差异性，将各种存储资源转化为统一管理的数据存储管理，可以用来存储虚拟机磁盘、虚拟机配置信息、快照等信息，使用户对存储的管理更加同质化

FC Fibre Channel 网状通道

文件系统 
---

文件系统作用在于提供文件操作接口，屏蔽存储设备的差异，为虚拟化卷文件提供存放空间

当前FusionCompute所使用的文件系统为VIMS 、EXT4 、NFS
```txt
-----------------------------------------------------------------
|    | 所需存储设备 | 是否创建文件系统 | 是否支持共享 | 是否支持延迟置零卷|
|VIMS| LUN        |     是         |   是       |     是         |
|EXT4| 本地磁盘    |     是         |   否       |     是          |
|NFS | 共享目录    |     是         |   是       |     否          |
-----------------------------------------------------------------
```
计算集群共享存储设备上的文件系统为 VIMS文件系统或NFS文件系统

VIMS(Virtual Image Manage System)

VIMS高性能集群文件系统，是Thin Provisioning、快照、存储迁移等高级特性的技术基础；兼容FC SAN IPSAN NAS 本地磁盘；支持固定空间磁盘、动态空间磁盘、差分磁盘等

应用场景 需要存储迁移、快照、链接、克隆等高级存储特性虚拟机

VIMS高性能集群文件系统，使虚拟化技术的应用超出了单个存储系统的限制，其设计、构建和优化针对虚拟服务器环境，可让多个虚拟机共同访问一个整合的集群式存储池，从而提高了资源利用率。

虚拟磁盘文件

VHD镜像格式是FusionCompute实现精简卷、快照等功能的基本载体，实现了FusionCompute虚拟机镜像数据的基本存储功能；虚拟机的一个虚拟磁盘对应一个VHD文件

虚拟磁盘文件格式 固态磁盘文件 动态磁盘文件 差分磁盘文件

一个虚拟机在虚拟化计算节点文件系统上表现为一个或多个虚拟磁盘文件，也就是说，一个虚拟机磁盘体现为一个或多个虚拟磁盘文件

页面中虚拟磁盘文件格式有3种，学员需要了解和掌握各种磁盘格式特点；正是虚拟机配备的虚拟磁盘格式，决定了虚拟机是否支持如精简磁盘配置，快照和链接克隆等高级功能。

固态磁盘文件
---

- 创建时需要将磁盘文件对应的存储块空间全部进行初始化成"0",创建速度慢，IO性能最佳；用于IOPS要求较高的场景。
- 磁盘大小恒定，创建后使用空间和预留空间相等
- 未写满的时候内部空间包含大量0，数据冗余度很高
- 应用在系统中的普通卷
```txt
0扇区 ......    |  最后一个扇区 |
  数据区        |  磁盘属性信息 |
```
IO要求高，且不用高级特性(如快照等)是虚拟机使用该类型

动态磁盘文件
---
- 创建时只需写头和结束块，创建速度快，IO性能较差；应用于精简磁盘和普通延迟置零磁盘
- 磁盘大小会随着用户写入数据而增长，但不随着用户删除数据而缩减，只能通过磁盘空间回收来手动缩减应用在系统中的精简磁盘空间
- 通过工具可以和静态磁盘互相转换；例如，可以从一个精简磁盘的模板部署一个普通磁盘的虚拟机
```txt
0扇区 1 2 ... m扇区 |   n0 |   ...  | n1    | ...... | ... | 最后一个扇区 |
属性信息            | 位表0 | 数据区0 | 位表1 | 数据1   | ... | 属性信息    |
```
- 动态磁盘中保持的数据是按需分配的，但是用户删除数据后，不能缩减，因此可能存在一部分垃圾数据，可以通过磁盘空间回收来处理
- 可以利用精简磁盘类型的虚拟机模板部署一个固态磁盘类型的虚拟机

差分磁盘文件
---
- 差分磁盘的结构和动态磁盘一模一样，只是文件头中会记录它的父文件路径
- 差分卷不能独立存在，必须能够访问到父文件才能正常工作。
- 差分卷也可以成为父文件
- 差分磁盘的特性和动态盘类似，但是很多业务有限制
- 差分磁盘以块为单位记录相对于父文件的修改
- 配合快照、非持久化磁盘、链接克隆等功能被使用，起到保护源盘不被修改，并可以跟踪虚拟机磁盘差异数据的作用。
```txt
0扇区| 1 |...|m扇区| 1 | ... | k扇区 | n0 | ...  | n1  | ...  | ... |最后一个扇区|
属 性 信 息        | 父 文 件 信 息   |位表0|数据区0|位表1|数据区1|  ...| 属性信息   |
```
链接克隆虚拟机使用的磁盘文件类型

存储虚拟化特性
---

精简磁盘和空间回收
---

功能特性 支持创建精简磁盘，可以随着用户使用而自动分配空间；膨胀的精简磁盘不会随着用户删除数据而缩小，使用空间回收工具可以将用户删除的数据空间释放到数据存储
```txt
未使用精简配置                       使用精简配置

2TB   2TB  2TB  分配但未使用 -----> 未分配
6TB   4TB  5TB  分配且已使用 ----->分配已使用 6TB  4TB  5TB
在主机上占用的容量21TB              在主机上占用的容量 15TB
```
适用场景  1. 精简磁盘可应用于局点运行初期，用户磁盘使用率低的情况。能够降低初始存储投资及维护成本。存储设备只保存有效数据，不保存预留空间，可以提高存储资源利用率；2. 空间回收可以提高精简磁盘的使用/分配比，提高存储利用率。

创建虚拟机可以选择精简磁盘模式，提高磁盘使用率，增加虚拟机部署密度

快照原理和应用
---

快照功能特性
- 快照记录了虚拟机在某一时间点的内容和状态
- 通过恢复虚拟机快照使虚拟机多次快速恢复到这一时间点
- 快照包含磁盘内容、虚拟机配置信息、内存数据
- 多次快照之间保存差量数据，节约存储空间

适用场景
- 虚拟机用户在执行一些重大、高危操作前，例如系统补丁，升级，破坏性测试前执行快照，故障时快速还原
- 用户触发的创建快照和恢复快照操作

快照方式包括
- COW写时拷贝
- ROW写时重定向
- WA随机写

存储虚拟化的快照

创建快照时会生成一个新的差分卷，虚拟机会挂载这个差分卷作为磁盘文件，虚拟机的读请求会重定向到源卷中。
创建快照采用了ROW(Redirect on Write)技术，快照后的写操作会进行重定向，所有的写IO都会被重定向到新的卷中，所有旧数据均保留在只读源卷中
```txt
快照前             快照后
  ^                        | |
  |                        | | 写操作
  | 读写操作 ------> 读操作--- ---------->磁盘文件
  v                快照文件(原磁盘文件)
磁盘文件
```
快照链
---

磁盘做多个快照后，会产生一个快照链；虚拟机卷始终挂载在快照链的最末端;一个虚拟机生成快照的数量不能超过32个，也是快照链最大长度；用户可以从当前状态恢复到快照链中的某个状态。；快照链中任意一个快照都可以删除而不影响其余快照。

snap1 ---> snap2 ---> VOL ---VM

链接克隆
---

链接克隆的功能特性： 
- 链接克隆技术是通过将源卷和差分卷组合映射为一个链接克隆卷，提供给虚拟机使用的技术。
- 一个链接克隆模板可以创建多个链接克隆差分卷，对应创建多个链接克隆虚拟机
- 新创建的差分卷占用空间很小，随着虚拟机的使用，空间逐渐膨胀

适用场景
- 能够快速、批量部署虚拟机
- 对于类似的虚拟机，公用的数据可以放在模板中，提高存储利用率

模板+差分卷=新的VM

虚拟机虚拟磁盘的迁移
---

虚拟机虚拟磁盘文件迁移特性 存储虚拟化支持将虚拟机的磁盘从一个数据存储迁移到另一个数据存储。；可以将虚拟机所有磁盘整体迁移，也可以单个磁盘分别迁移；虚拟机的快照可以一起迁移；虚拟机开启或者关闭时都可以迁移；

适用场景 将数据存储的所有卷迁移后，可以对数据存储进行减容；可以调整数据存储之间的负荷

存储热迁移原理
---

- 在目的存储上创建一个与源相同的空镜像文件
- 将目的存储的镜像文件设置为源镜像文件的mirror,使虚拟机的IO写也能落盘在目的存储上，保证脏块数据的同步
- 通过迭代迁移技术，将源镜像的数据迁移到目的的镜像中，保证了基线数据的同步
- 在基线数据同步完成后，短暂的时间内暂停虚拟机的IO请求，将虚拟机的存储文件从源镜像切换到目的镜像上，这样完成了存储的迁移
- 存储热迁移同时迁移虚拟机磁盘镜像和系统内存状态


