目录
1. 计算虚拟化基础概念
2. CPU虚拟化
3. 内存虚拟化
4. FusionSphere关键特性

虚拟化本质
- 分区 在单一物理服务器上同时运行多个虚拟机
- 隔离 同一服务器上虚拟机之间相互隔离
- 封装 整个虚拟机都保存在文件中，而且通过移动和复制这些文件的方式来移动和复制虚拟机
- 相对于硬件独立 无需修改即可在任何服务器上运行虚拟机

分区： 意味着虚拟化层为多个虚拟机划分服务器资源的能力；每个虚拟机同时运行一个单独操作系统，使服务器能够运行多个程序；每个操作系统只能看到虚拟化层提供的“虚拟硬件”

隔离：虚拟机是相互隔离的
>一个虚拟机崩溃或者故障，不会影响同一服务器上的其它虚拟机

>可以进行资源控制以提供性能隔离

封装：整个虚拟机存储独立于物理硬件的一小组文件中。这样在外部只需复制几个文件就可以随时随地根据需要复制保存和移动虚拟机
```txt
      | 寄宿虚拟化           | 裸金属虚拟化      | 混合虚拟化 |
| 优点 | 简单容易实现         | 支持多种操作系统   |
| 缺点 | 管理开销大           |虚拟层内核开发难度大|虚底层虚拟化扩展功能|
| 厂家 | VMware Workstation |VMware vSphere   |Redhat KVM|
```

DomU: 运行在Xen Hypervisor上的普通虚拟机
Dom0: 运行在Xen Hypervisor上的特权虚拟机，拥有访问物理I/O资源的权限，同时和系统上运行的其它虚拟机进行交互。Dom0需要在其它Domain启动之前启动
```txt
Domain 0       | Domain U |     虚拟机复用有限的外设资源
用户态 控制面板  |  用户态  |      VMM截获guestOS对设备访问请求，然后通过软件方式
内核            | 内核    |      来模拟真实设备的效果
设备驱动 后端驱动 | 前端驱动 |      前端设备驱动将数据通过VMM提供的接口转发到后端驱动
                                后端驱动VM的数据进行分通道进行处理
    虚拟机监控器VMM
物理硬件(处理器，内存，IO设备)
```
I/O虚拟化需要解决两个问题
- 设备发现 需要控制各虚拟机能够访问设备
- 访问截获 通过I/O端口对设备访问

硬件辅助虚拟化
VT-X是Intel运用虚拟化技术中的一个指令集，是CPU虚拟化的技术，AMD处理器类似功能称为AMD-V

主机内存超分配 Host Memory和Guest Memory之间并不是一一对应。可以超分配内存给VM，通过内存复用技术实现超分配功能。

CPU QoS
-场景1，上限是2GHz,虚拟机可用CPU资源最多为2GHz ;场景2:按比例分配 ；场景3 VM1预留2GHz,VM1预留0，那么竞争时，VM2获得1GHz(3-2=1)

内存复用技术
- 内存共享、写时复制 内存共享：虚拟机之间共享同一物理内存空间，此时虚拟机仅对内存只读操作；写时复制 当虚拟机需要对内存进行写操作时，开辟另一内存空间，并修改映射。
- 内存置换 虚拟机长时间未访问的内存内容被置换到存储中，并建立映射。当虚拟机再次访问内存内容时再置换回来
- 内存气泡 Hypervisor通过内存气泡将较为空闲的虚拟机内存释放给内存使用率较高的虚拟机，从而提高内存使用率

虚拟机内存QoS
- 内存预留(下限) 虚拟机预留的最低物理内存,预留的内存会被虚拟机独占。一旦内存被某个虚拟机预留，即使虚拟机实际内存使用量不超过预留量，其它虚拟机也无法抢占该虚拟机空闲的内存资源
- 内存份额 适用于资源复用场景，按比例分配内存资源 

虚拟机热迁移

技术特点 基于内存压缩传输技术，虚拟机热迁移效率提升1倍；虚拟机磁盘数据位置不变，只是更改映射关系

适用场景 可容忍短时间中断，但必须要快速恢复业务，比如轻量级数据库业务、桌面云业务

存储热迁移 

技术特点 热迁移可以使客户可以在业务无损的情况下动态调整虚拟机存储资源，以实现设备维护，存储DRS资源调整等操作

无共享热迁移

技术特点 将源物理机上指定的处于运行状态的非共享虚拟机迁移到另一台虚拟机上，以实现不同存储介质上的虚拟机在不同节点之间无缝在线迁移

整机迁移技术，可以让不同存储介质上的虚拟机，在不同的节点之间无缝地进行在线迁移，摆脱共享存储的限制

整机迁移存在以下约束限制：1. 虚拟机整机迁移只支持虚拟化存储 2. 虚拟机整机迁移不支持链接克隆虚拟机 3. 包含共享卷的虚拟机不允许整机迁移

虚拟机热迁移应用场景 服务器下电维护 新老硬件更换 数据迁移 性能优化 服务器补丁升级 本地虚拟机迁移

异构热迁移
- 跨代处理器使用不同的处理器架构，CPU特性不兼容，因此不能热迁移
- 新架构CPU调整为旧架构CPU模式，时集群内所有主机运行在相同CPU模式
- 集群内一台主机CPU版本较低，集群需要运行在较低模式，导致整体性能降低，资源浪费
- 支持的最高CPU指令集

建议规划集群时，节点间CPU模式支持能力不要差距太大，导致整体性能较低，资源浪费



