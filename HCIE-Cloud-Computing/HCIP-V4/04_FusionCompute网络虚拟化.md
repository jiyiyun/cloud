1. 网络虚拟化相关概念及技术
2. 网络虚拟化功能特性

分布式交换机一方面可以对多台服务器的虚拟交换机进行统一配置、管理、监控；另一方面可以保证虚拟机在服务器之间迁移时网络配置的统一性。

Linux Bridge 网桥是工作在二层的虚拟网络设备，类似于交换机

Bridge可以绑定其它Linux网络设备作为从设备，并将这些设备虚拟化为端口，当一个设备被绑定到bridge上时，就相当于真实网络中交换机端口插入了一个连接有终端的网线。

VM--tap0--br0--eth0---local Switch

br0绑定了实际物理网卡eth0 与虚拟设备tap0 ,对于hypervisor的网络协议栈上层来说，指看到br0，并不会关注网桥细节，br0根据MAC地址与端口映射关系进行转发

OVS OpenSwitch 是一款基于软件实现的开源虚拟交换机，支持多种标准的管理接口协议(例如NetFlow/sFlow/SPAN/RSPAN/CLI/LACP/802.1q等)支持多物理服务器分布式环境(类似与VMware vSwitch思科的Nexus 1000v等)

OpenFlow交换机将原来由switch/Router控制的报文转发转化为OpenFlow Switch 和控制服务器Controller共同进行，从而实现了数据转发和路由控制分离。控制器可以通过事先规定好的接口操作来控制OpenFlow的流表，从而实现控制数据转发的目的

OpenFlow网络由OpenFlow交换机、FlowVisor和Controller三部分组成，OpenFlow交换机进行数据转发，FlowVisor对网络进行虚拟化，Controller对网络进行集中控制实现控制层功能

OpenFlow交换机由流表、安全通道和OpenFlow协议三部分组成

DVS 每台主机都连接打到DVS中，DVS一端连接虚拟机一端连接主机物理网口上的上行链路。通过DVS实现虚拟机网络对外互通，分布式交换机在所有关联主机之间作为单个虚拟交换机使用，这使虚拟机跨主机迁移时确保网络一致

EVS Elastic Virtual Switch 是基于OVS转发的技术，提升了其I/O性能的一种弹性化虚拟交换

依然符合OpenFlow标准

其中IO性能提升了Intel DPDK技术，通过用户态进程接管网卡数据收发，采用“I/O独占内核”技术，每个端口分配一个核用于数据收发，这种轮询方式比中断式处理更高效，因而IO性能有显著提升。

EVS关键技术　物理网卡访问DPDK高速数据通道；2. 报文处理：使用大页内存；3.交换业务处理：轮询转发，减少调度开销，多核（线程）并行处理；OpenFlow流表转发优化；　４．前后端　vhost-user技术

华为分布式交换方案

方案特点　１．集中管理　２．开源Open vSwitch 3. 丰富的虚拟交换二层特性，包括交换，QoS,安全隔离等

华为分布式虚拟交换支持基于开源Open ｖSwitch的纯软件的虚拟交换功能，同时提供完整虚拟交换卸载的智能网卡的虚拟交换

虚拟交换管理通过不同的插件管理Open vSwitch和智能网卡

FusionCompute分布式交换机　可以向虚拟机提供虚拟独立的网络平面，不同网络平面之间通过VLAN进行隔离

通过分布在各物理服务器的虚拟交换机，提供虚拟机二层通信、隔离、QoS的能力

分布式交换机特征
- 可以配置多个分布式交换机，分布式交换机可以覆盖集群中多个CNA节点
- 分布式交换机具有多个分布式的虚拟端口VSP ，每个VSP具有各自属性(速率),为管理采用Port Group组管理相同属性的一组端口，相同端口组的VLAN相同
- 业务相同(VDI/IDC)，可以选择管理/存储/业务使用不同物理接口；每个分布式交换机可以配置一个Uplink端口或者一个Uplink端口组，用于VM对外通信，Uplink端口聚合组可以包含多个物理端口，端口聚合组可以配置负载均衡策略。
- 每个VM可以具有多个vNIC接口，vNIC可以和交换机的VSP一一对接
- 业务系统可以根据业务需求，选择在一个集群内允许进行2层迁移服务器，创建二层网络，设置该网络使用的VLAN信息

虚拟交换模型

- 虚拟化管理员通过定义端口组属性(安全/QoS)，简化对虚拟机端口属性的设置；设置端口组属性，不影响虚拟机正常工作
- 端口组　端口组是网络属性相同的一组端口的属性集合。管理员可以通过配置端口组属性(带宽QoS、２层安全属性、VLAN等)简化对虚拟机端口属性的设置。设置端口组属性。不影响虚拟机正常工作
- 上行链路　分布式交换机的服务器物理网口；管理员可以查询上行链路名称、速率、模式、状态等信息
- 上行链路聚合　分布式交换机关联的服务器绑定网口，绑定网口可以包含多个物理网口，这些物理网口可以配置主备或负载均衡策略

FusionCompute中的虚拟机通信

- 跨主机　经过外部物理网络
- 不跨主机，跨VLAN ，经过外部网络
- 不跨主机，不跨网络，只跨DVS，不经过外部网络

网络虚拟化功能特性
---

华为虚拟交换模式　　普通模式、SR-IOV直通模式、用户态交换模式

普通交换　VM的eth0 <---连接--->br1的tap0 <---连接---> br-eth1/br-bond <---连接--->eth/bond

普通交换模式下，虚拟机有前后端两个虚拟网卡设备，其中，前端网卡连接在虚拟交换机的虚拟端口上。虚拟机网络数据包通过环形缓冲区和事件通道在前后端网卡之间传输，并最终通过后端网卡连接的虚拟交换机实现转发

SR-IOV  VM guest Driver <------> VMM层　PCI管理　<--->PF 物理硬件[VF智能网卡 ]

SR-IOV技术在Intel在2007年提出的网络I/O虚拟化技术，支持SR-IOV的物理网卡可以虚拟出多个网卡供虚拟机使用。相对于硬件直通技术PCI Passthrough 又减少了硬件网卡数量

用户态交换 通过DPDK (Data Plane Development Kit,数据平面开发套件，DPDK是一系列库和驱动的集合)技术，用来在x86平台进行快速的数据包处理。通过环境抽象层旁路内核协议栈、轮询模式的报文无中断收发、优化内存/缓冲区/队列管理、基于网卡多队列和流识别的负载均衡等多项技术，实现了在x86处理架构下的高性能报文转发能力，提高虚拟机网络性能。

支持用户态交换模式网卡型号　Intel 82599ES Intel XL710和mellanox MT27712A0

网络安全策略　二层网络安全策略

二层网络安全策略包括　防止用户虚拟机IP和MAC地址仿冒，防止用户虚拟机DHCP Server仿冒

防止IP地址和MAC仿冒(IP和MAC绑定)　防止用户修改IP MAC 发起IP MAC仿冒攻击。通过生成IP-MAC绑定关系，基于IP源侧防护( IP Source Guard)和动态ARP检测(DAI)对非绑定关系的报文进行过滤

防止DHCP Server仿冒(DHCP Server隔离)　禁止虚拟机用户启动DHCP Server服务

网络安全策略 - 广播报文抑制

虚拟机提供虚拟机端口发送方向的广播报文抑制开关，以及抑制阈值设置功能。可以通过开启虚拟机网卡所在端口组的广播包抑制开关设置阈值，减少过量报文对二层网络带宽的消耗

管理员可以通过系统的Portak，基于虚拟交换机端口组的对象，配置报文抑制开关和报文抑制带宽阈值

网络安全策略 - 安全组

用户根据虚拟机安全需求建立安全组，每个安全组可以设定一组访问规则。当虚拟机加入安全组后，即收到该访问规则组的保护。用户通过在创建虚拟机时选定要加入安全组来对自身的虚拟机进行安全隔离和访问控制

Trunk 口　　虚拟机网卡通过虚拟端口接入虚拟交换机进行网络数据包的转发；虚拟交换机端口支持配置为Trunk类型。并允许设置trunk的VLAN ID范围，之后虚拟端口具备了同时收发携带不同VLAN标签的网络数据包的功能，从而满足了虚拟网卡支持Trunk类型端口的需求

网络QoS 网络QoS策略提供带宽配置控制能力　基于端口组成员接口发送方向与接收方向的带宽控制；基于端口组的每个成员接口提供流量整型，带宽优先级的控制能力

网卡绑定(类似于物理网络设备的将多条线路聚合、捆扎、e-th 、aggregatation、boud) 主机网卡绑定　管理员可以绑定CNA主机网口，提高网络的可靠性；针对普通网卡和DPDK驱动的物理网卡均可设置端口绑定

普通网卡绑定模式可以选择　主备　轮询　基于源目的IP和端口负荷分担　基于源目的MAC的负荷分担　基于源目的MAC的LACP 基于目的IP的LACP

对于支持DPDK驱动的物理网卡，绑定模式可以选择　主备　基于源目的的MAC的LACP模式　基于源目的的IP和端口的LACP模式

